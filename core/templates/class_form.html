{% extends "base.html" %}
{% block title %}Create Class{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Create Class</h1>
<form method="post" class="space-y-6">
    {% csrf_token %}
    <div>
        <label for="{{ form.name.id_for_label }}" class="block mb-1 font-semibold">Name</label>
        {{ form.name }}
    </div>
    <div>
        <label class="block mb-1 font-semibold">Hit Die</label>
        <div class="flex items-center gap-2">
            <span>d</span>
            {{ form.hit_die }}
        </div>
    </div>
    <div>
        <label for="{{ form.description.id_for_label }}" class="block mb-1 font-semibold">Description</label>
        {{ form.description }}
    </div>
    <div>
        <h3 class="font-semibold mb-2">Level Map</h3>
        <div class="flex items-end gap-2">
            <input id="level-number" type="number" min="1" max="20" class="input input-bordered w-20" placeholder="Lvl">
            <input id="level-search" type="text" class="input input-bordered flex-1" placeholder="Search features..." autocomplete="off">
        </div>
        <div id="level-results" class="mt-2 space-x-2"></div>
        <div id="level-map" class="mt-4 space-y-2"></div>
        {{ form.level_map }}
    </div>
    <fieldset class="border p-4 rounded-lg">
        <legend class="font-semibold">Optional Properties</legend>
        <div class="space-y-6">
            <div>
                <label for="{{ form.saving_throws.id_for_label }}" class="block mb-1 font-semibold">Saving Throw Proficiencies</label>
                {{ form.saving_throws }}
            </div>
            <div>
                <h3 class="font-semibold mb-2">Skill Proficiency Options</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.skill_choose.id_for_label }}" class="block mb-1">Choose</label>
                        {{ form.skill_choose }}
                    </div>
                    <div>
                        <label for="{{ form.skill_options.id_for_label }}" class="block mb-1">From</label>
                        {{ form.skill_options }}
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
    <div>
        <button type="submit" class="btn btn-primary">Save Class</button>
    </div>
</form>
{% endblock %}
{% block extra_scripts %}
<script>
const levelInput = document.getElementById('level-number');
const searchInput = document.getElementById('level-search');
const resultsDiv = document.getElementById('level-results');
const mapDiv = document.getElementById('level-map');
const hiddenInput = document.getElementById('id_level_map');
let levelMap = {};

function updateHidden() {
  const data = {};
  Object.keys(levelMap).forEach(lvl => {
    data[lvl] = levelMap[lvl].map(f => f.id);
  });
  hiddenInput.value = JSON.stringify(data);
}

function renderMap() {
  mapDiv.innerHTML = '';
  Object.keys(levelMap).sort((a,b) => a - b).forEach(lvl => {
    const container = document.createElement('div');
    const title = document.createElement('h4');
    title.textContent = 'Level ' + lvl;
    title.className = 'font-semibold';
    container.appendChild(title);
    const featsDiv = document.createElement('div');
    levelMap[lvl].forEach(feat => {
      const badge = document.createElement('span');
      badge.className = 'badge badge-outline mr-1 mb-1';
      badge.textContent = feat.name;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ml-1 text-xs';
      btn.textContent = '\u2715';
      btn.addEventListener('click', () => {
        levelMap[lvl] = levelMap[lvl].filter(f => f.id !== feat.id);
        if (!levelMap[lvl].length) delete levelMap[lvl];
        renderMap();
        updateHidden();
      });
      badge.appendChild(btn);
      featsDiv.appendChild(badge);
    });
    container.appendChild(featsDiv);
    mapDiv.appendChild(container);
  });
}

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  const lvl = parseInt(levelInput.value);
  if (!q || !lvl) { resultsDiv.innerHTML = ''; return; }
  fetch(`/api/search?q=${encodeURIComponent(q)}`)
    .then(resp => resp.json())
    .then(data => {
      resultsDiv.innerHTML = '';
      data.results.filter(item => item.model === 'feat').forEach(item => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-xs btn-outline mr-1 mb-1';
        btn.textContent = item.name;
        btn.addEventListener('click', () => {
          if (!levelMap[lvl]) levelMap[lvl] = [];
          if (!levelMap[lvl].some(f => f.id === item.id)) levelMap[lvl].push({id: item.id, name: item.name});
          renderMap();
          updateHidden();
        });
        resultsDiv.appendChild(btn);
      });
    });
});
</script>
{% endblock %}
