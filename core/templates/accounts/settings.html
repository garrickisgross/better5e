{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}Account Settings · better5e{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto">
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title">Account Settings</h2>

      <div class="mt-2 space-y-2">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm opacity-70">Username</div>
            <div class="font-medium">{{ request.user.username }}</div>
          </div>
        </div>

        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm opacity-70">Email</div>
            <div class="font-medium">{{ request.user.email|default:'—' }}</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <h3 class="font-semibold">Dice Appearance</h3>
      <form method="post" class="grid gap-3 mt-2">
        {% csrf_token %}
        <input type="hidden" name="_section" value="dice" />
        <div class="form-control">
          <label class="label"><span class="label-text">Color preset</span></label>
          {{ dice_form.dice_preset|add_class:"select select-bordered" }}
          <div class="text-xs opacity-70 mt-1">Used when no external theme is set.</div>
          {{ dice_form.dice_preset.errors }}
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Finish</span></label>
          {{ dice_form.dice_finish|add_class:"select select-bordered" }}
          {{ dice_form.dice_finish.errors }}
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">External theme URL (optional)</span></label>
          <div class="flex gap-2">
            {{ dice_form.dice_external_theme_url|add_class:"input input-bordered grow" }}
            <button id="diceThemeTestBtn" type="button" class="btn btn-ghost">Test</button>
            <button id="diceThemeLoadBtn" type="button" class="btn btn-outline">Load</button>
          </div>
          <label class="label"><span class="label-text-alt">{{ dice_form.dice_external_theme_url.help_text }}</span></label>
          {{ dice_form.dice_external_theme_url.errors }}
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
      </form>

      <div id="diceThemeAlerts" class="mt-3 space-y-2"></div>

      <div class="divider"></div>

      <div class="flex flex-wrap gap-2">
        <a href="{% url 'password_change' %}" class="btn btn-ghost">Change password</a>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline">Logout</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<script>
  (function(){
    const alerts = document.getElementById('diceThemeAlerts');
    const urlInput = document.getElementById('id_dice_external_theme_url');
    const btnTest = document.getElementById('diceThemeTestBtn');
    const btnLoad = document.getElementById('diceThemeLoadBtn');

    function addAlert(kind, text) {
      const klass = kind === 'success' ? 'alert-success' : (kind === 'warning' ? 'alert-warning' : 'alert-error');
      const el = document.createElement('div');
      el.className = `alert ${klass} shadow`;
      el.innerHTML = `<span>${text}</span>`;
      alerts.prepend(el);
      setTimeout(() => { el.remove(); }, 7000);
    }
    function getCsrf() {
      const m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }
    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || `Request failed: ${res.status}`);
      return data;
    }

    if (btnTest) btnTest.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) { addAlert('error', 'Enter a URL to test.'); return; }
      btnTest.disabled = true; btnTest.classList.add('loading');
      try {
        const resp = await postJSON('{% url "core:dice_theme_test" %}', { url });
        addAlert('success', `Theme OK. Mesh: ${resp.meshFile}. Assets: ${resp.assets.length}`);
      } catch (e) {
        addAlert('error', e.message);
      } finally {
        btnTest.disabled = false; btnTest.classList.remove('loading');
      }
    });

    if (btnLoad) btnLoad.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) { addAlert('error', 'Enter a URL to load.'); return; }
      btnLoad.disabled = true; btnLoad.classList.add('loading');
      try {
        const resp = await postJSON('{% url "core:dice_theme_load" %}', { url });
        addAlert('success', `Theme cached. Files saved: ${resp.saved.length}`);
      } catch (e) {
        addAlert('error', e.message);
      } finally {
        btnLoad.disabled = false; btnLoad.classList.remove('loading');
      }
    });
  })();
</script>
